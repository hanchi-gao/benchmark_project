services:
  # vLLM server container
  vllm-server:
    image: ${VLLM_IMAGE:-vllm-rocm71:latest}
    container_name: vllm-server
    devices:
      - /dev/kfd
      - /dev/dri
    group_add:
      - video
    ipc: host
    cap_add:
      - SYS_PTRACE
    security_opt:
      - seccomp=unconfined
    volumes:
      - ~/.cache/huggingface:/root/.cache/huggingface
      - ./scripts:/root/scripts
      - ./output:/root/output
    environment:
      - HF_HOME=/root/.cache/huggingface
      - PYTORCH_TUNABLEOP_ENABLED=0
      - VLLM_USE_TRITON_FLASH_ATTN=0
      - OMP_NUM_THREADS=32
    ports:
      - "8001:8000"
    networks:
      - vllm-network
    stdin_open: true
    tty: true
    command: /bin/bash

  # Benchmark client container
  vllm-bench-client:
    image: ${VLLM_IMAGE:-vllm-rocm71:latest}
    container_name: vllm-bench-client
    devices:
      - /dev/kfd
      - /dev/dri
    group_add:
      - video
    ipc: host
    cap_add:
      - SYS_PTRACE
    security_opt:
      - seccomp=unconfined
    volumes:
      - ~/.cache/huggingface:/root/.cache/huggingface
      - ./scripts:/root/scripts
      - ./output:/root/output
    environment:
      - VLLM_SERVER_URL=http://vllm-server:8000
      - HF_HOME=/root/.cache/huggingface
      - PYTORCH_TUNABLEOP_ENABLED=0
      - VLLM_USE_TRITON_FLASH_ATTN=0
    networks:
      - vllm-network
    stdin_open: true
    tty: true
    command: /bin/bash

networks:
  vllm-network:
    driver: bridge
